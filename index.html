<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes, viewport-fit=cover" />
  <title>Taíno Conuco Layout • v5</title>

  <!--
  Taíno Conuco Layout Tool (v5)

  Controls
  - Apply: apply coordinate inputs
  - Reset: restore defaults
  - Center: zero coords + reset view
  - Grid: toggle crosshairs/grid
  - Fit: frame all elements

  Gestures
  - Drag element: move
  - Drag background: pan
  - Pinch: zoom
  - Double-tap: zoom in
  - Double-tap with two fingers: zoom out
  - Mouse wheel: zoom to cursor

  Hosting
  - Save as index.html in your repo root
  - Enable GitHub Pages → main branch → / (root)
  - Visit https://<user>.github.io/<repo>/
  -->

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{ --gap:10px; --radius:10px; }
    body{
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:#f5f1e8; color:#222; line-height:1.3; padding:var(--gap);
    }
    .container{
      width:min(100%, 920px); margin-inline:auto; background:#fff; border:2px solid #333;
      padding:var(--gap); border-radius:var(--radius);
    }
    h1{ font-size:clamp(14px,3.8vw,20px); text-align:center; margin-bottom:6px; }
    .badge{ text-align:center; font-size:11px; color:#666; margin-bottom:8px; }

    .controls{
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px;
    }
    @media (min-width:600px){ .controls{ grid-template-columns:repeat(5,1fr); } }
    button{
      padding:12px; background:#4a4a4a; color:#fff; border:0; border-radius:8px;
      font-size:clamp(11px,3.2vw,14px); cursor:pointer; touch-action:manipulation;
    }
    button:active{ background:#666; }

    .coords{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:8px; margin-bottom:10px; font-size:clamp(10px,2.8vw,12px);
    }
    .coord-item{ background:#f9f9f9; padding:8px; border-left:3px solid #666; border-radius:6px; }
    .coord-item strong{ display:block; margin-bottom:4px; font-size:clamp(10px,2.8vw,12px); }
    .coord-item input{
      width:64px; padding:6px 5px; font-size:clamp(11px,3vw,13px); margin:0 4px;
      border:1px solid #ccc; border-radius:6px; -webkit-text-size-adjust:100%;
    }

    .measurements{
      background:#fffde7; padding:8px; margin-bottom:10px; font-size:clamp(10px,2.8vw,12px);
      border-left:3px solid #daa520; border-radius:6px; min-height:20px;
    }
    .measurements div{ margin:2px 0; }
    .live{ color:#06c; font-weight:700; }

    #canvasWrapper{
      width:100%; height:min(62dvh,560px); min-height:260px;
      border:2px solid #333; background:#fff; overflow:hidden; position:relative; border-radius:var(--radius);
    }
    canvas{ display:block; width:100%; height:100%; cursor:crosshair; touch-action:none; }

    /* Mini-map overlay */
    #miniMap {
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 140px;
      height: 100px;
      border: 1px solid #333;
      background: #ffffffcc;
      border-radius: 6px;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Taíno Conuco Layout Tool</h1>
    <div class="badge">build v5 • pinch+zoom, inertia, fit, mini-map</div>

    <div class="controls">
      <button id="applyBtn">Apply</button>
      <button id="resetDefaultBtn">Reset</button>
      <button id="resetZeroBtn">Center</button>
      <button id="toggleGridBtn">Grid</button>
      <button id="fitBtn">Fit</button>
    </div>

    <div class="coords" id="coordInputs"></div>
    <div class="measurements" id="measurements">Loading…</div>

    <div id="canvasWrapper">
      <canvas id="canvas"></canvas>
      <canvas id="miniMap"></canvas>
    </div>
  </div>

  <script>
    // --- Error reporter
    window.onerror = function(msg, src, line, col){
      document.getElementById('measurements').innerHTML =
        '<div style="color:#b00020"><strong>Error:</strong> ' + msg + '</div>';
    };

    if (!Math.hypot) Math.hypot = function(x,y){return Math.sqrt(x*x+y*y);};

    var canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d',{alpha:true});
    var wrapper=document.getElementById('canvasWrapper');
    var mini=document.getElementById('miniMap'), mctx=mini.getContext('2d');

    var SCALE=10;
    var CENTER_X=350, CENTER_Y=400, showGrid=true, elements=[];
    var panX=0, panY=0, viewScale=1, MIN_SCALE=0.5, MAX_SCALE=4;

    var dragging=null, dragOffX=0, dragOffY=0, panning=false, panStartX=0, panStartY=0;
    var pinching=false, pinchStartDist=0, pinchStartScale=1, pinchFocalX=0, pinchFocalY=0;
    var inertiaVX=0, inertiaVY=0, inertiaId=0, lastMoveTime=0, lastMoveX=0, lastMoveY=0;

    var defaultCoords={ barn:{x:-270,y:60}, house:{x:100,y:60}, planter:{x:-170,y:-240},
      conuco:{x:10,y:-170}, yopo:{x:-5,y:-105}, septic:{x:-150,y:280}, palm:{x:130,y:250} };

    // Buttons
    document.getElementById('applyBtn').onclick=applyCoordinates;
    document.getElementById('resetDefaultBtn').onclick=resetToDefault;
    document.getElementById('resetZeroBtn').onclick=resetViewAndCoords;
    document.getElementById('toggleGridBtn').onclick=function(){showGrid=!showGrid;draw();};
    document.getElementById('fitBtn').onclick=fitToExtents;

    // Coord inputs
    function createCoordInputs(){
      var ids=Object.keys(defaultCoords), out=[];
      for(var i=0;i<ids.length;i++){
        var id=ids[i], c=defaultCoords[id];
        out.push('<div class="coord-item"><strong>'+id+'</strong>'+
          'X:<input type="number" id="'+id+'X" value="'+c.x+'">'+
          'Y:<input type="number" id="'+id+'Y" value="'+c.y+'"></div>');
      }
      document.getElementById('coordInputs').innerHTML=out.join('');
    }

    function getValue(id,axis){var v=parseInt(document.getElementById(id+axis).value,10);return isNaN(v)?0:v;}

    function createElement(){
      function get(id,a){return getValue(id,a)+(a==='X'?CENTER_X:CENTER_Y);}
      elements=[
        {id:'barn',type:'rect',x:get('barn','X'),y:get('barn','Y'),width:180,height:160,color:'#d4c5a0',label:'BARN',draggable:true},
        {id:'house',type:'rect',x:get('house','X'),y:get('house','Y'),width:160,height:160,color:'#e8dcc8',label:'House',draggable:true},
        {id:'planter',type:'rect',x:get('planter','X'),y:get('planter','Y'),width:80,height:50,color:'#c07860',label:'Planter',draggable:true},
        {id:'conuco',type:'circle',x:get('conuco','X'),y:get('conuco','Y'),radius:50,color:'#8b7355',label:'CONUCO',draggable:true},
        {id:'yopo',type:'rect',x:get('yopo','X'),y:get('yopo','Y'),width:30,height:30,color:'#4a4a4a',label:'Y',draggable:true},
        {id:'septic',type:'circle',x:get('septic','X'),y:get('septic','Y'),radius:35,color:'#e0e0e0',label:'SEPTIC',draggable:true,dash:true},
        {id:'palm',type:'special',x:get('palm','X'),y:get('palm','Y'),radius:15,color:'#8b7355',label:'Palm',draggable:true}
      ];
      var conuco=elements[3], pos=[[-30,35],[-15,45],[15,45],[30,35],[0,48],[48,0],[-48,0],[0,-48]];
      for(var i=0;i<pos.length;i++){elements.push({id:'cassava'+(i+1),type:'circle',
        x:conuco.x+pos[i][0],y:conuco.y+pos[i][1],radius:6,color:'#228b22',label:'',draggable:true});}
      updateMeasurements();
    }

    function updateMeasurements(){
      var m=document.getElementById('measurements');
      function g(id){for(var i=0;i<elements.length;i++)if(elements[i].id===id)return elements[i];}
      function d(e1,e2){return Math.hypot(e1.x-e2.x,e1.y-e2.y)/SCALE;}
      var barn=g('barn'),house=g('house'),planter=g('planter'),conuco=g('conuco'),septic=g('septic'),palm=g('palm');
      m.innerHTML='<div>Barn→Planter:<span class="live">'+d(barn,planter).toFixed(1)+'</span>ft</div>'+
        '<div>Barn→Septic:<span class="live">'+d(barn,septic).toFixed(1)+'</span>ft</div>'+
        '<div>Barn→House:<span class="live">'+(Math.abs(house.x-(barn.x+barn.width))/SCALE).toFixed(1)+'</span>ft</div>'+
        '<div>House→Palm:<span class="live">'+d(house,palm).toFixed(1)+'</span>ft</div>'+
        '<div>Palm→Septic:<span class="live">'+d(palm,septic).toFixed(1)+'</span>ft</div>'+
        '<div>Conuco→Septic:<span class="live">'+((d(conuco,septic)*SCALE-conuco.radius-septic.radius)/SCALE).toFixed(1)+'</span>ft</div>'+
        '<div>Conuco→Barn:<span class="live">'+d(conuco,barn).toFixed(1)+'</span>ft</div>';
    }

    // --- Drawing
    function draw(){
      var dpr=Math.max(1,window.devicePixelRatio||1);
      ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.setTransform(dpr*viewScale,0,0,dpr*viewScale,dpr*panX,dpr*panY);
      var w=canvas.width/dpr, h=canvas.height/dpr;
      ctx.fillStyle='#333'; ctx.font='bold 11px Arial'; ctx.textAlign='center';
      ctx.fillText('NORTH',CENTER_X,20); ctx.fillText('SOUTH',CENTER_X,h-20);
      if(showGrid){ctx.strokeStyle='#ddd';ctx.lineWidth=1/viewScale;
        for(var x=0;x<=w;x+=100){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
        for(var y=0;y<=h;y+=100){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
        ctx.strokeStyle='#999';ctx.lineWidth=2/viewScale;
        ctx.beginPath();ctx.moveTo(CENTER_X,0);ctx.lineTo(CENTER_X,h);ctx.stroke();
        ctx.beginPath();ctx.moveTo(0,CENTER_Y);ctx.lineTo(w,CENTER_Y);ctx.stroke();}
      for(var i=0;i<elements.length;i++)drawEl(elements[i]);
      drawMiniMap();
    }

    function drawEl(el){
      ctx.save();
      if(el.type==='rect'){ctx.fillStyle=el.color;ctx.strokeStyle='#333';ctx.lineWidth=2/viewScale;
        ctx.fillRect(el.x,el.y,el.width,el.height);ctx.strokeRect(el.x,el.y,el.width,el.height);}
      else if(el.type==='circle'){ctx.fillStyle=el.color;ctx.strokeStyle='#333';ctx.lineWidth=(el.radius>10?2:1)/viewScale;
        if(el.dash)ctx.setLineDash([5/viewScale,5/viewScale]);ctx.beginPath();
        ctx.arc(el.x,el.y,el.radius,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.setLineDash([]);}
      else{ctx.fillStyle=el.color;ctx.strokeStyle='#333';ctx.lineWidth=2/viewScale;ctx.beginPath();
        ctx.ellipse(el.x,el.y,12,20,0,0,Math.PI*2);ctx.fill();ctx.stroke();}
      ctx.restore();
    }

    // --- Mini-map
    function getWorldBounds(){
      var minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;
      for(var i=0;i<elements.length;i++){var e=elements[i];
        if(e.type==='rect'){minX=Math.min(minX,e.x);minY=Math.min(minY,e.y);maxX=Math.max(maxX,e.x+e.width);maxY=Math.max(maxY,e.y+e.height);}
        else{var r=e.radius||15;minX=Math.min(minX,e.x-r);minY=Math.min(minY,e.y-r);maxX=Math.max(maxX,e.x+r);maxY=Math.max(maxY,e.y+r);} }
      return {minX:minX,minY:minY,maxX:maxX,maxY:maxY};
    }

    function drawMiniMap(){
      var dpr=Math.max(1,window.devicePixelRatio||1);
      mctx.setTransform(1,0,0,1,0,0); mctx.clearRect(0,0,mini.width,mini.height);
      var b=getWorldBounds(), worldW=b.maxX-b.minX, worldH=b.maxY-b.minY;
      var pad=6*dpr, vw=mini.width-pad*2, vh=mini.height-pad*2, s=Math.min(vw/worldW,vh/worldH);
      var ox=pad-b.minX*s, oy=pad-b.minY*s;
      mctx.strokeStyle='#333';mctx.strokeRect(b.minX*s+ox,b.minY*s+oy,worldW*s,worldH*s);
      for(var i=0;i<elements.length;i++){var e=elements[i];mctx.strokeStyle='#666';
        if(e.type==='rect')mctx.strokeRect(e.x*s+ox,e.y*s+oy,e.width*s,e.height*s);
        else{var r=(e.radius||15)*s;mctx.beginPath();mctx.arc(e.x*s+ox,e.y*s+oy,r,0,Math.PI*2);mctx.stroke();}}
      var rect=canvas.getBoundingClientRect(), cssW=rect.width, cssH=rect.height;
      var tlx=(-panX)/viewScale, tly=(-panY)/viewScale, brx=(cssW-panX)/viewScale, bry=(cssH-panY)/viewScale;
      mctx.strokeStyle='#0a84ff';mctx.lineWidth=2*dpr;
      mctx.strokeRect(tlx*s+ox,tly*s+oy,(brx-tlx)*s,(bry-tly)*s);
    }

    // --- Fit to extents
    function fitToExtents(){
      var b=getWorldBounds(), rect=canvas.getBoundingClientRect(), pad=40, viewW=rect.width-pad*2, viewH=rect.height-pad*2;
      var s=Math.min(viewW/(b.maxX-b.minX), viewH/(b.maxY-b.minY)); s=Math.max(MIN_SCALE,Math.min(MAX_SCALE,s));
      var cx=(b.minX+b.maxX)/2, cy=(b.minY+b.maxY)/2;
      viewScale=s; panX=rect.width/2 - cx*viewScale; panY=rect.height/2 - cy*viewScale; draw();
    }

    // --- Resize
    function resizeCanvas(){
      var rect=wrapper.getBoundingClientRect(), dpr=Math.max(1,window.devicePixelRatio||1);
      canvas.width=Math.floor(rect.width*dpr); canvas.height=Math.floor(rect.height*dpr);
     
