<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes, viewport-fit=cover" />
  <title>Taíno Conuco Layout • v4 (pinch & zoom)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{ --gap:10px; --radius:10px; }
    body{
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:#f5f1e8; color:#222; line-height:1.3; padding:var(--gap);
    }
    .container{
      width:min(100%, 920px); margin-inline:auto; background:#fff; border:2px solid #333;
      padding:var(--gap); border-radius:var(--radius);
    }
    h1{ font-size:clamp(14px,3.8vw,20px); text-align:center; margin-bottom:6px; }
    .badge{ text-align:center; font-size:11px; color:#666; margin-bottom:8px; }

    .controls{
      display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:10px;
    }
    @media (min-width:600px){ .controls{ grid-template-columns:repeat(4,1fr); } }
    button{
      padding:12px; background:#4a4a4a; color:#fff; border:0; border-radius:8px;
      font-size:clamp(11px,3.2vw,14px); cursor:pointer; touch-action:manipulation;
    }
    button:active{ background:#666; }

    .coords{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:8px; margin-bottom:10px; font-size:clamp(10px,2.8vw,12px);
    }
    .coord-item{ background:#f9f9f9; padding:8px; border-left:3px solid #666; border-radius:6px; }
    .coord-item strong{ display:block; margin-bottom:4px; font-size:clamp(10px,2.8vw,12px); }
    .coord-item input{
      width:64px; padding:6px 5px; font-size:clamp(11px,3vw,13px); margin:0 4px;
      border:1px solid #ccc; border-radius:6px; -webkit-text-size-adjust:100%;
    }

    .measurements{
      background:#fffde7; padding:8px; margin-bottom:10px; font-size:clamp(10px,2.8vw,12px);
      border-left:3px solid #daa520; border-radius:6px; min-height:20px;
    }
    .measurements div{ margin:2px 0; }
    .live{ color:#06c; font-weight:700; }

    #canvasWrapper{
      width:100%;
      height:min(62dvh,560px);
      min-height:260px;
      border:2px solid #333; background:#fff; overflow:hidden; position:relative; border-radius:var(--radius);
    }
    canvas{ display:block; width:100%; height:100%; cursor:crosshair; touch-action:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Taíno Conuco Layout Tool</h1>
    <div class="badge">build v4 • pinch+zoom enabled</div>

    <div class="controls">
      <button id="applyBtn">Apply</button>
      <button id="resetDefaultBtn">Reset</button>
      <button id="resetZeroBtn">Center</button>
      <button id="toggleGridBtn">Grid</button>
    </div>

    <div class="coords" id="coordInputs"></div>
    <div class="measurements" id="measurements">Loading…</div>

    <div id="canvasWrapper">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <script>
    // ---- Error reporter to the yellow bar
    (function(){
      var meas = document.getElementById('measurements');
      window.onerror = function(msg, src, line, col){
        meas.innerHTML = '<div style="color:#b00020"><strong>Error:</strong> ' + String(msg) +
                         ' @ ' + (line||'?') + ':' + (col||'?') + '</div>';
      };
    })();

    if (!Math.hypot) { Math.hypot = function(x,y){ return Math.sqrt(x*x+y*y); }; }

    var canvas  = document.getElementById('canvas');
    var ctx     = canvas.getContext('2d', { alpha:true });
    var wrapper = document.getElementById('canvasWrapper');

    var SCALE = 10;

    var CENTER_X = 350;
    var CENTER_Y = 400;
    var showGrid = true;
    var elements = [];

    // --- View transform (pan/zoom) in CSS pixels
    var panX = 0, panY = 0;
    var viewScale = 1;
    var MIN_SCALE = 0.5, MAX_SCALE = 4;

    // Drag state
    var dragging = null;    // element being dragged (in world coords)
    var dragOffX = 0, dragOffY = 0;
    var panning = false;    // background pan
    var panStartX = 0, panStartY = 0;

    // Pinch state
    var pinching = false;
    var pinchStartDist = 0, pinchStartScale = 1;
    var pinchFocalX = 0, pinchFocalY = 0; // CSS px focal point

    var defaultCoords = {
      barn:    {x:-270, y:  60},
      house:   {x: 100, y:  60},
      planter: {x:-170, y:-240},
      conuco:  {x:  10, y:-170},
      yopo:    {x:  -5, y:-105},
      septic:  {x:-150, y: 280},
      palm:    {x: 130, y: 250}
    };

    // Buttons
    document.getElementById('applyBtn').addEventListener('click', applyCoordinates);
    document.getElementById('resetDefaultBtn').addEventListener('click', resetToDefault);
    document.getElementById('resetZeroBtn').addEventListener('click', resetViewAndCoords);
    document.getElementById('toggleGridBtn').addEventListener('click', function(){
      showGrid = !showGrid; draw();
      document.getElementById('measurements').insertAdjacentHTML('beforeend',
        '<div>Grid: <span class="live">' + (showGrid ? 'on' : 'off') + '</span></div>');
    });

    function createCoordInputs(){
      var ids = Object.keys(defaultCoords), out=[];
      for (var i=0;i<ids.length;i++){
        var id = ids[i];
        out.push(
          '<div class="coord-item">'+
          '<strong>'+ id.charAt(0).toUpperCase()+id.slice(1) +'</strong>'+
          'X:<input type="number" id="'+id+'X" inputmode="numeric" value="'+defaultCoords[id].x+'">'+
          'Y:<input type="number" id="'+id+'Y" inputmode="numeric" value="'+defaultCoords[id].y+'">'+
          '</div>'
        );
      }
      document.getElementById('coordInputs').innerHTML = out.join('');
    }

    function getValue(id, axis){
      var n = parseInt(document.getElementById(id+axis).value, 10);
      return isNaN(n) ? 0 : n;
    }

    function createElement(){
      function get(id, axis){ return getValue(id,axis) + (axis==='X'?CENTER_X:CENTER_Y); }

      elements = [
        { id:'barn', type:'rect', x:get('barn','X'), y:get('barn','Y'), width:180, height:160, color:'#d4c5a0', label:'BARN', draggable:true },
        { id:'house', type:'rect', x:get('house','X'), y:get('house','Y'), width:160, height:160, color:'#e8dcc8', label:'House', draggable:true },
        { id:'planter', type:'rect', x:get('planter','X'), y:get('planter','Y'), width:80, height:50, color:'#c07860', label:'Planter', draggable:true },
        { id:'conuco', type:'circle', x:get('conuco','X'), y:get('conuco','Y'), radius:50, color:'#8b7355', label:'CONUCO', draggable:true },
        { id:'yopo', type:'rect', x:get('yopo','X'), y:get('yopo','Y'), width:30, height:30, color:'#4a4a4a', label:'Y', draggable:true },
        { id:'septic', type:'circle', x:get('septic','X'), y:get('septic','Y'), radius:35, color:'#e0e0e0', label:'SEPTIC', draggable:true, dash:true },
        { id:'palm', type:'special', x:get('palm','X'), y:get('palm','Y'), radius:15, color:'#8b7355', label:'Palm', draggable:true }
      ];

      var conuco = elements[3];
      var pos = [[-30,35],[-15,45],[15,45],[30,35],[0,48],[48,0],[-48,0],[0,-48]];
      for (var i=0;i<pos.length;i++){
        elements.push({
          id:'cassava'+(i+1), type:'circle',
          x:conuco.x+pos[i][0], y:conuco.y+pos[i][1],
          radius:6, color:'#228b22', label:'', draggable:true
        });
      }

      updateMeasurements();
    }

    function updateMeasurements(){
      var meas = document.getElementById('measurements');
      function get(id){ for (var i=0;i<elements.length;i++) if (elements[i].id===id) return elements[i]; return null; }
      function dist(e1,e2){ return Math.hypot(e1.x-e2.x, e1.y-e2.y) / SCALE; }
      var barn=get('barn'), house=get('house'), planter=get('planter');
      var conuco=get('conuco'), septic=get('septic'), palm=get('palm');

      meas.innerHTML =
        '<div>Barn → Planter: <span class="live">'+ dist(barn,planter).toFixed(1) +'</span> ft</div>'+
        '<div>Barn → Septic: <span class="live">'+ dist(barn,septic).toFixed(1) +'</span> ft</div>'+
        '<div>Barn → House: <span class="live">'+ (Math.abs(house.x-(barn.x+barn.width))/SCALE).toFixed(1) +'</span> ft</div>'+
        '<div>House → Palm: <span class="live">'+ dist(house,palm).toFixed(1) +'</span> ft</div>'+
        '<div>Palm → Septic: <span class="live">'+ dist(palm,septic).toFixed(1) +'</span> ft</div>'+
        '<div>Conuco → Septic: <span class="live">'+ ((dist(conuco,septic)*SCALE - conuco.radius - septic.radius)/SCALE).toFixed(1) +'</span> ft</div>'+
        '<div>Conuco → Barn: <span class="live">'+ dist(conuco,barn).toFixed(1) +'</span> ft</div>';
    }

    function updateInputs(){
      for (var i=0;i<elements.length;i++){
        var el=elements[i], x=document.getElementById(el.id+'X'), y=document.getElementById(el.id+'Y');
        if (x) x.value = Math.round(el.x - CENTER_X);
        if (y) y.value = Math.round(el.y - CENTER_Y);
      }
    }

    // ---- Drawing with DPR + view transform
    function draw(){
      var dpr = Math.max(1, window.devicePixelRatio || 1);
      // Clear in pixel space
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Apply combined transform: DPR then view (scale+pan) in CSS px
      ctx.setTransform(dpr*viewScale, 0, 0, dpr*viewScale, dpr*panX, dpr*panY);

      var w = canvas.width  / dpr;
      var h = canvas.height / dpr;

      // Titles (these are in world coords now)
      ctx.fillStyle = '#333';
      ctx.font = 'bold 11px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('NORTH', CENTER_X, 20);
      ctx.fillText('SOUTH', CENTER_X, h - 20);

      drawGrid(w,h);
      for (var i=0;i<elements.length;i++) drawElement(elements[i]);
    }

    function drawGrid(w,h){
      if (!showGrid) return;
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1 / viewScale; // keep lines thin when zoomed
      var x, y;
      for (x=0; x<=w; x+=100){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for (y=0; y<=h; y+=100){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

      ctx.strokeStyle = '#999';
      ctx.lineWidth = 2 / viewScale;
      ctx.beginPath(); ctx.moveTo(CENTER_X,0); ctx.lineTo(CENTER_X,h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,CENTER_Y); ctx.lineTo(w,CENTER_Y); ctx.stroke();

      ctx.fillStyle = '#666';
      ctx.font = (10 / viewScale) + 'px Arial';
      ctx.fillText('0,0', CENTER_X + 3, CENTER_Y - 3);
    }

    function drawElement(el){
      if (el.type==='rect'){
        ctx.fillStyle = el.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 2 / viewScale;
        ctx.fillRect(el.x, el.y, el.width, el.height);
        ctx.strokeRect(el.x, el.y, el.width, el.height);
        if (el.label){
          ctx.fillStyle = '#000';
          ctx.font = 'bold ' + (11 / viewScale) + 'px Arial';
          ctx.textAlign = 'center';
          var lines = el.label.split('\n');
          for (var i=0;i<lines.length;i++){
            ctx.fillText(lines[i], el.x + el.width/2, el.y + el.height/2 + (i - 0.5) * (13 / viewScale));
          }
        }
      } else if (el.type==='circle'){
        ctx.fillStyle = el.color; ctx.strokeStyle = '#333';
        ctx.lineWidth = (el.radius>10 ? 2 : 1) / viewScale;
        if (el.dash){ ctx.setLineDash([5/ viewScale, 5/ viewScale]); }
        ctx.beginPath(); ctx.arc(el.x, el.y, el.radius, 0, Math.PI*2);
        ctx.fill(); ctx.stroke(); ctx.setLineDash([]);
        if (el.label){
          ctx.fillStyle = '#000';
          ctx.font = (el.radius > 30 ? 9 : 8) / viewScale + 'px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(el.label, el.x, el.y + 3 / viewScale);
        }
      } else if (el.type==='special'){
        ctx.fillStyle = el.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 2 / viewScale;
        ctx.beginPath(); ctx.ellipse(el.x, el.y, 12, 20, 0, 0, Math.PI*2);
        ctx.fill(); ctx.stroke();
        ctx.strokeStyle = '#2d5016';
        for (var i=0;i<5;i++){
          ctx.beginPath();
          ctx.moveTo(el.x, el.y - 15);
          var angle = (i - 2) * 0.4;
          ctx.quadraticCurveTo(el.x + Math.sin(angle)*15, el.y - 30, el.x + Math.sin(angle)*20, el.y - 40);
          ctx.stroke();
        }
      }
    }

    // ---- Picking helpers (convert screen -> world)
    function screenToWorld(px, py){
      // px/py are CSS pixels relative to canvas
      return {
        x: (px - panX) / viewScale,
        y: (py - panY) / viewScale
      };
    }

    function getElementAtWorld(x, y){
      for (var i=elements.length-1; i>=0; i--){
        var el = elements[i];
        if (!el.draggable) continue;
        if (el.type==='rect' && x>=el.x && x<=el.x+el.width && y>=el.y && y<=el.y+el.height){ return el; }
        if (el.type==='circle' || el.type==='special'){
          var r = (el.radius != null ? el.radius : 15);
          if (Math.hypot(x-el.x, y-el.y) <= r + 15) return el;
        }
      }
      return null;
    }

    // ---- Input handling
    function getCanvasCoordsClient(clientX, clientY){
      var rect = canvas.getBoundingClientRect();
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // Mouse (desktop) — wheel zoom & panning with background drag
    canvas.addEventListener('wheel', function(e){
      e.preventDefault();
      var p = getCanvasCoordsClient(e.clientX, e.clientY);
      zoomAt(p.x, p.y, e.deltaY < 0 ? 1.1 : 1/1.1);
    }, { passive:false });

    var lastClickTime = 0;
    canvas.addEventListener('mousedown', function(e){
      var p = getCanvasCoordsClient(e.clientX, e.clientY);
      var world = screenToWorld(p.x, p.y);
      dragging = getElementAtWorld(world.x, world.y);
      if (dragging){
        dragOffX = world.x - dragging.x;
        dragOffY = world.y - dragging.y;
      } else {
        panning = true; panStartX = p.x - panX; panStartY = p.y - panY;
      }

      // double-click zoom
      var now = Date.now();
      if (now - lastClickTime < 300){ zoomAt(p.x, p.y, 1.6); }
      lastClickTime = now;
    });
    window.addEventListener('mousemove', function(e){
      if (dragging || panning){
        var p = getCanvasCoordsClient(e.clientX, e.clientY);
        if (dragging){
          var w = screenToWorld(p.x, p.y);
          dragging.x = w.x - dragOffX;
          dragging.y = w.y - dragOffY;
          updateInputs(); updateMeasurements(); draw();
        } else {
          panX = p.x - panStartX; panY = p.y - panStartY; draw();
        }
      }
    });
    window.addEventListener('mouseup', function(){ dragging=null; panning=false; });

    // Touch (mobile) — single: drag/pan, double-tap: zoom, two-finger: pinch
    canvas.addEventListener('touchstart', function(e){
      if (e.touches.length===1){
        var t=e.touches[0], p=getCanvasCoordsClient(t.clientX,t.clientY), w=screenToWorld(p.x,p.y);
        dragging = getElementAtWorld(w.x,w.y);
        if (dragging){ dragOffX = w.x - dragging.x; dragOffY = w.y - dragging.y; }
        else { panning = true; panStartX = p.x - panX; panStartY = p.y - panY; }

        // double-tap zoom
        var now = Date.now();
        if (now - lastClickTime < 350){ zoomAt(p.x, p.y, 1.6); e.preventDefault(); }
        lastClickTime = now;
      } else if (e.touches.length===2){
        pinching = true; dragging = null; panning = false;
        var a=e.touches[0], b=e.touches[1];
        pinchStartDist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
        pinchStartScale = viewScale;
        var cx=(a.clientX+b.clientX)/2, cy=(a.clientY+b.clientY)/2;
        var p = getCanvasCoordsClient(cx, cy);
        pinchFocalX = p.x; pinchFocalY = p.y;
      }
    }, { passive:false });

    canvas.addEventListener('touchmove', function(e){
      if (pinching && e.touches.length===2){
        e.preventDefault();
        var a=e.touches[0], b=e.touches[1];
        var dist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
        var factor = dist / pinchStartDist;
        setZoomAt(pinchFocalX, pinchFocalY, pinchStartScale * factor);
      } else if (e.touches.length===1 && (dragging || panning)){
        e.preventDefault();
        var t=e.touches[0], p=getCanvasCoordsClient(t.clientX,t.clientY);
        if (dragging){
          var w=screenToWorld(p.x,p.y);
          dragging.x = w.x - dragOffX;
          dragging.y = w.y - dragOffY;
          updateInputs(); updateMeasurements(); draw();
        } else {
          panX = p.x - panStartX; panY = p.y - panStartY; draw();
        }
      }
    }, { passive:false });

    canvas.addEventListener('touchend', function(){
      pinching=false; dragging=null; panning=false;
    });

    // Zoom helpers
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    function setZoomAt(focalX, focalY, newScale){
      newScale = clamp(newScale, MIN_SCALE, MAX_SCALE);
      // Keep the world point under focalX/focalY stationary:
      var worldX = (focalX - panX) / viewScale;
      var worldY = (focalY - panY) / viewScale;
      viewScale = newScale;
      panX = focalX - worldX * viewScale;
      panY = focalY - worldY * viewScale;
      draw();
    }
    function zoomAt(focalX, focalY, factor){ setZoomAt(focalX, focalY, viewScale * factor); }

    // Canvas sizing with DPR
    function resizeCanvas(){
      var rect = wrapper.getBoundingClientRect();
      var dpr  = Math.max(1, window.devicePixelRatio || 1);
      canvas.width  = Math.max(1, Math.floor(rect.width  * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));
      CENTER_X = rect.width / 2;
      CENTER_Y = rect.height / 2;
      draw();
    }

    function setupResizeWatcher(){
      if (window.ResizeObserver){
        var ro = new ResizeObserver(resizeCanvas);
        ro.observe(wrapper);
      } else {
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
      }
    }

    // Controls
    function applyCoordinates(){ createElement(); draw(); }
    function resetToDefault(){
      for (var key in defaultCoords){
        var c = defaultCoords[key];
        document.getElementById(key+'X').value = c.x;
        document.getElementById(key+'Y').value = c.y;
      }
      createElement(); draw();
    }
    function resetViewAndCoords(){
      // Center/reset view (pan/zoom) AND zero coords as before
      panX = panY = 0; viewScale = 1;
      var ids=['barn','house','planter','conuco','yopo','septic','palm'];
      for (var i=0;i<ids.length;i++){
        document.getElementById(ids[i]+'X').value = 0;
        document.getElementById(ids[i]+'Y').value = 0;
      }
      createElement(); draw();
    }
    function toggleGrid(){ showGrid = !showGrid; draw(); }

    // ---- Init
    createCoordInputs();
    resizeCanvas();
    createElement();
    draw();
    setupResizeWatcher();
  </script>
</body>
</html>
