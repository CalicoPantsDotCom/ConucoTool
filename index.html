<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes, viewport-fit=cover" />
<title>AI Taíno Conuco Layout Tool • v7.0</title>
<style>
  /* --- base / palette approximating the Tailwind snippets --- */
  :root{
    --indigo-600:#4f46e5; --indigo-700:#4338ca; --indigo-500:#6366f1;
    --indigo-focus:rgba(99,102,241,.35);
    --border:#dadde2; --border-dark:#444a57;
    --bg:#f5f1e8; --paper:#fff; --paper-dark:#1f2937;
    --txt:#111827; --txt-dim:#6b7280; --txt-inv:#fff;
    --btn-dark:#4a4a4a; --btn-dark-2:#3f3f3f;
    --accent:#0a84ff; --danger:#b00020;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--txt); line-height:1.3; padding:10px;
  }
  .app{
    max-width:1100px; margin:0 auto; background:var(--paper);
    border:1px solid var(--border); border-radius:12px; overflow:hidden;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    display:grid; grid-template-rows:auto auto auto 1fr;
  }
  /* Header polish (Claude’s pattern) */
  header{ padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); }
  header h1{ text-align:center; font-weight:800; font-size:18px; color:#111827; }
  header p{ text-align:center; font-size:11px; color:#6b7280; margin-top:2px; }

  /* Toolbar: primary + secondary styles (approx Tailwind) */
  .bars{ padding:10px 12px; display:grid; gap:8px; border-bottom:1px solid var(--border); background:#fff; }
  .controls{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:8px; }
  .tools{ display:grid; grid-template-columns:260px 160px repeat(6,1fr); gap:8px; }
  @media (max-width:940px){
    .controls{grid-template-columns:repeat(4,1fr)}
    .tools{grid-template-columns:1fr 1fr 1fr}
  }
  button{ border:0; border-radius:10px; font-size:14px; font-weight:600; padding:10px 12px; cursor:pointer; transition:background .12s ease, box-shadow .12s ease, opacity .12s; }
  .btn-primary{
    color:#fff; background:var(--indigo-600);
  }
  .btn-primary:hover{ background:var(--indigo-700); }
  .btn-primary:focus{ outline:none; box-shadow:0 0 0 4px var(--indigo-focus); }
  .btn-primary:disabled{ background:#a5b4fc; cursor:not-allowed; }
  .btn-secondary{
    color:#111827; background:#fff; border:1px solid var(--border);
  }
  .btn-secondary:hover{ background:#f3f4f6; }
  .btn-secondary:focus{ outline:none; box-shadow:0 0 0 2px var(--indigo-focus); }
  .danger{ background:#ef4444;color:#fff; } .danger:hover{background:#dc2626}

  .field{ display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
  .field label{ font-size:13px; color:#374151; }
  input[type=number]{ width:72px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; font-size:14px; }

  .hint{ padding:8px 12px; font-size:12px; color:#374151; border-bottom:1px solid var(--border); background:#fff; }

  /* Layout: sidebar + canvas row */
  .main{ display:grid; grid-template-columns:260px 1fr; min-height:58dvh; }
  @media (max-width:900px){ .main{ grid-template-columns:1fr; } }

  /* Sidebar shape list */
  .sidebar{ border-right:1px solid var(--border); background:#fff; }
  .side-head{ padding:10px 12px; font-size:12px; color:#6b7280; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .shape-list{ list-style:none; padding:6px; max-height:calc(62dvh - 60px); overflow:auto; }
  .shape-item{ display:flex; align-items:center; gap:8px; padding:8px; border:1px solid transparent; border-radius:10px; cursor:pointer;}
  .shape-item:hover{ background:#f9fafb; }
  .shape-item.active{ border-color:var(--indigo-600); background:#eef2ff; }
  .shape-chip{ width:10px; height:10px; border-radius:3px; border:1px solid #0002; }
  .shape-name{ flex:1; font-size:14px; }
  .shape-name[contenteditable="true"]{ outline:2px solid var(--indigo-focus); background:#fff; border-radius:6px; padding:0 4px; }
  .side-actions button{ font-size:12px; padding:6px 8px; }

  /* Canvas container (Claude’s Canvas.tsx look) */
  .canvas-wrap{
    position:relative; background:#fff; border:1px solid var(--border);
    border-radius:12px; overflow:hidden; margin:10px; min-height:360px;
    box-shadow:inset 0 1px 4px rgba(0,0,0,.06);
  }
  canvas{ display:block; width:100%; height:100%; touch-action:none; }
  #miniMap{ position:absolute; right:12px; bottom:12px; width:150px; height:110px; border:1px solid #333; background:#ffffffcc; border-radius:10px; }

  /* Measurements bar (re-using) */
  .measure{ margin:10px; background:#fffde7; border-left:3px solid #daa520; border-radius:8px; padding:8px 10px; font-size:13px; }
  .measure .live{ color:#0a66c2; font-weight:800; }

  /* Resize handles + hover/active feedback */
  .cursor-default{ cursor:default; }
  .cursor-move{ cursor:grab; } .cursor-move:active{ cursor:grabbing; }
  .cursor-ns{ cursor:ns-resize; } .cursor-ew{ cursor:ew-resize; }
  .cursor-nesw{ cursor:nesw-resize; } .cursor-nwse{ cursor:nwse-resize; }

  /* Live size tooltip */
  .tooltip{
    position:absolute; z-index:4; pointer-events:none;
    background:#111827; color:#fff; font-size:12px; padding:4px 6px; border-radius:6px;
    box-shadow:0 2px 8px rgba(0,0,0,.2); transform:translate(-50%,-120%);
    white-space:nowrap;
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>AI Taíno Conuco Layout Tool</h1>
      <p>v7.0</p>
    </header>

    <div class="bars">
      <div class="controls">
        <button class="btn-primary" id="applyBtn">Apply</button>
        <button class="btn-secondary" id="resetBtn">Reset</button>
        <button class="btn-secondary" id="centerBtn">Center</button>
        <button class="btn-secondary" id="gridBtn">Grid</button>
        <button class="btn-secondary" id="fitBtn">Fit</button>
        <button class="btn-secondary" id="undoBtn" disabled>Undo</button>
        <button class="btn-secondary" id="redoBtn" disabled>Redo</button>
      </div>

      <div class="tools">
        <div class="field"><label for="cassCount">Cassava count</label><input id="cassCount" type="number" min="0" max="24" step="1" value="8"></div>
        <div class="field"><label for="lockCass">Lock to Conuco</label><input id="lockCass" type="checkbox" checked></div>
        <button class="btn-secondary" id="addRectBtn">Add Rect</button>
        <button class="btn-secondary" id="addCircleBtn">Add Circle</button>
        <button class="btn-secondary" id="delSelectedBtn">Delete Selected</button>
        <button class="btn-secondary" id="clearCassBtn">Clear Cassava</button>
      </div>
    </div>

    <div class="hint">Drag shapes to move. Drag handles to resize (rect: 8 handles; circle: radius handle). Hover shows correct resize cursor. Tooltip displays live size. Double-tap to zoom. Shortcuts: <b>G</b>rid, <b>F</b>it, <b>Del</b>ete, <b>Ctrl/Cmd+Z</b> Undo, <b>Ctrl/Cmd+Y</b> Redo.</div>

    <div class="main">
      <aside class="sidebar">
        <div class="side-head">
          <span>Shapes</span>
          <div class="side-actions">
            <button class="btn-secondary" id="renameBtn">Rename</button>
            <button class="btn-secondary danger" id="sideDeleteBtn">Delete</button>
          </div>
        </div>
        <ul class="shape-list" id="shapeList"></ul>
      </aside>

      <section>
        <div class="measure" id="measurements">Loading…</div>
        <div class="canvas-wrap" id="canvasWrapper">
          <canvas id="canvas"></canvas>
          <canvas id="miniMap"></canvas>
          <div id="tooltip" class="tooltip" style="display:none">—</div>
        </div>
      </section>
    </div>
  </div>

<script>
/* ===== Utility & setup ===== */
if(!Math.hypot){Math.hypot=(x,y)=>Math.sqrt(x*x+y*y)}
const DPR=()=>Math.max(1,window.devicePixelRatio||1);

const wrap=document.getElementById('canvasWrapper');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{alpha:true});
const mini=document.getElementById('miniMap');
const mctx=mini.getContext('2d');
const tooltip=document.getElementById('tooltip');

const SCALE=10; // px/ft for readouts only
let CENTER_X=350, CENTER_Y=400, showGrid=true;
let panX=0, panY=0, viewScale=1, MIN_SCALE=.5, MAX_SCALE=4;

let elements=[];
let selected=null;
let dragging=null, dragOffX=0, dragOffY=0;
let resizing=null, hoverHandle=null;
let panning=false, pinching=false;
let pinchStartDist=0, pinchStartScale=1, pinchFocalX=0, pinchFocalY=0;
let inertiaVX=0, inertiaVY=0, inertiaId=0, lastMoveTime=0, lastMoveX=0, lastMoveY=0, lastTap=0;
let addMode=null;

const defaults={
  barn:    {x:-260,y:40,w:180,h:140,label:'BARN',  color:'#d4c5a0'},
  house:   {x:130,y:40,w:160,h:160,label:'HOUSE', color:'#e8dcc8'},
  planter: {x:-160,y:-210,w:90,h:60,label:'PLANTER',color:'#c07860'},
  septic:  {x:-150,y:270,r:40,label:'SEPTIC',color:'#e0e0e0',dash:true},
  conuco:  {x:20,y:-160,r:45,label:'CONUCO',color:'#8b7355'},
  yopo:    {x:-5,y:-105,w:30,h:30,label:'Y',color:'#4a4a4a'},
  palm:    {x:130,y:240,r:18,label:'PALM',color:'#8b7355',special:true}
};

/* ===== History (Undo/Redo) ===== */
const undoBtn=document.getElementById('undoBtn');
const redoBtn=document.getElementById('redoBtn');
let past=[], future=[];
function snapshot(){
  const state={
    panX,panY,viewScale, CENTER_X,CENTER_Y, showGrid,
    elements: JSON.parse(JSON.stringify(elements)), sel: selected?.id || null
  };
  past.push(state); future.length=0; updateHistoryButtons();
}
function restore(state){
  panX=state.panX; panY=state.panY; viewScale=state.viewScale;
  CENTER_X=state.CENTER_X; CENTER_Y=state.CENTER_Y; showGrid=state.showGrid;
  elements=state.elements; selected= elements.find(e=>e.id===state.sel) || null;
  draw(); refreshList();
}
function doUndo(){ if(!past.length) return;
  const cur={panX,panY,viewScale,CENTER_X,CENTER_Y,showGrid,elements:JSON.parse(JSON.stringify(elements)), sel:selected?.id||null};
  const prev=past.pop(); future.push(cur); restore(prev); updateHistoryButtons();
}
function doRedo(){ if(!future.length) return;
  const cur={panX,panY,viewScale,CENTER_X,CENTER_Y,showGrid,elements:JSON.parse(JSON.stringify(elements)), sel:selected?.id||null};
  const nxt=future.pop(); past.push(cur); restore(nxt); updateHistoryButtons();
}
function updateHistoryButtons(){ undoBtn.disabled=!past.length; redoBtn.disabled=!future.length; }

/* ===== DOM refs ===== */
const applyBtn=document.getElementById('applyBtn');
const resetBtn=document.getElementById('resetBtn');
const centerBtn=document.getElementById('centerBtn');
const gridBtn=document.getElementById('gridBtn');
const fitBtn=document.getElementById('fitBtn');
const cassCountInput=document.getElementById('cassCount');
const lockCassInput=document.getElementById('lockCass');
const addRectBtn=document.getElementById('addRectBtn');
const addCircleBtn=document.getElementById('addCircleBtn');
const delSelectedBtn=document.getElementById('delSelectedBtn');
const clearCassBtn=document.getElementById('clearCassBtn');
const measurements=document.getElementById('measurements');

/* ===== Shapes ===== */
const wX=dx=>CENTER_X+dx, wY=dy=>CENTER_Y+dy;
const rectEl=(id,o)=>({id:id||('rect'+rand()),type:'rect',x:wX(o.x),y:wY(o.y),w:o.w,h:o.h,color:o.color||'#d9d9d9',label:o.label||'RECT',draggable:true,resizable:true});
const circleEl=(id,o)=>({id:id||('circle'+rand()),type:'circle',x:wX(o.x),y:wY(o.y),r:o.r||30,color:o.color||'#ddd',label:o.label||'CIRCLE',draggable:true,resizable:true,dash:!!o.dash});
const palmEl=(id,o)=>({id, type:'special', x:wX(o.x), y:wY(o.y), r:o.r, color:o.color, label:o.label, draggable:true, resizable:false});
const rand=()=>Math.random().toString(36).slice(2,7);
const get=id=>elements.find(e=>e.id===id);
function removeCassava(){ elements=elements.filter(e=>!/^cassava/.test(e.id)); }
function rebuildCassava(n){
  removeCassava(); if(n<=0) return; const c=get('conuco'); if(!c) return;
  const radius=Math.max(8,c.r-6);
  for(let i=0;i<n;i++){
    const ang=i/n*Math.PI*2, dx=Math.cos(ang)*radius, dy=Math.sin(ang)*radius;
    elements.push({id:'cassava'+(i+1),type:'circle',x:c.x+dx,y:c.y+dy,r:6,color:'#228b22',label:'',draggable:true,resizable:false,cassava:true});
  }
}

/* ===== Measurements ===== */
function updateMeasurements(){
  const d=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y)/SCALE;
  const barn=get('barn'), house=get('house'), planter=get('planter'), conuco=get('conuco'), septic=get('septic'), palm=get('palm');
  if(!(barn&&house&&planter&&conuco&&septic&&palm)){ measurements.textContent=''; return; }
  const cc=elements.filter(e=>e.cassava).length;
  measurements.innerHTML =
    `Barn → Planter: <span class="live">${d(barn,planter).toFixed(1)}</span> ft ·
     Barn → Septic: <span class="live">${d(barn,septic).toFixed(1)}</span> ft ·
     Barn → House gap: <span class="live">${(Math.abs(house.x-(barn.x+barn.w))/SCALE).toFixed(1)}</span> ft ·
     House → Palm: <span class="live">${d(house,palm).toFixed(1)}</span> ft ·
     Conuco R: <span class="live">${(conuco.r/SCALE).toFixed(1)}</span> ft ·
     Cassava: <span class="live">${cc}</span>`;
}

/* ===== Drawing ===== */
function viewBounds(){
  const r=canvas.getBoundingClientRect();
  const tlx=(-panX)/viewScale, tly=(-panY)/viewScale;
  const brx=(r.width-panX)/viewScale, bry=(r.height-panY)/viewScale;
  return {minX:tlx,minY:tly,maxX:brx,maxY:bry};
}
function draw(){
  const ratio=DPR();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(ratio*viewScale,0,0,ratio*viewScale, ratio*panX, ratio*panY);

  drawGrid();

  elements.forEach(drawElement);
  drawLabels();
  drawHandles();
  drawMiniMap();
}
function drawGrid(){
  if(!showGrid) return;
  const vb=viewBounds(), step=100;
  const sx=Math.floor((vb.minX-step*4)/step)*step, ex=Math.ceil((vb.maxX+step*4)/step)*step;
  const sy=Math.floor((vb.minY-step*4)/step)*step, ey=Math.ceil((vb.maxY+step*4)/step)*step;
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1/viewScale;
  for(let x=sx;x<=ex;x+=step){ ctx.beginPath(); ctx.moveTo(x,sy); ctx.lineTo(x,ey); ctx.stroke(); }
  for(let y=sy;y<=ey;y+=step){ ctx.beginPath(); ctx.moveTo(sx,y); ctx.lineTo(ex,y); ctx.stroke(); }
  ctx.strokeStyle='#9ca3af'; ctx.lineWidth=2/viewScale;
  ctx.beginPath(); ctx.moveTo(CENTER_X,sy); ctx.lineTo(CENTER_X,ey); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(sx,CENTER_Y); ctx.lineTo(ex,CENTER_Y); ctx.stroke();
}
function drawElement(el){
  if(el.type==='rect'){
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=2/viewScale;
    ctx.fillRect(el.x,el.y,el.w,el.h); ctx.strokeRect(el.x,el.y,el.w,el.h);
  }else if(el.type==='circle'){
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=(el.r>10?2:1)/viewScale;
    if(el.dash) ctx.setLineDash([5/viewScale,5/viewScale]);
    ctx.beginPath(); ctx.arc(el.x,el.y,el.r,0,Math.PI*2); ctx.fill(); ctx.stroke(); ctx.setLineDash([]);
  }else{ // palm
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=2/viewScale;
    ctx.beginPath(); ctx.ellipse(el.x,el.y,12,20,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.strokeStyle='#2d5016';
    for(let i=0;i<5;i++){ ctx.beginPath(); ctx.moveTo(el.x,el.y-15);
      const a=(i-2)*0.4; ctx.quadraticCurveTo(el.x+Math.sin(a)*15, el.y-30, el.x+Math.sin(a)*20, el.y-40); ctx.stroke(); }
  }
}
function screenPoint(wx,wy){ return {x:(wx*viewScale+panX)*DPR(), y:(wy*viewScale+panY)*DPR()}; }
function drawLabels(){
  ctx.setTransform(1,0,0,1,0,0); ctx.textAlign='center'; ctx.fillStyle='#111827';
  elements.forEach(el=>{
    if(!el.label) return;
    const cx=(el.type==='rect')? (el.x+el.w/2) : el.x;
    const cy=(el.type==='rect')? (el.y+el.h/2) : el.y;
    const p=screenPoint(cx, cy + 3/viewScale);
    const size=(el.type==='rect'?12:(el.r>30?10:9));
    ctx.font='700 '+Math.round(size*DPR())+'px Arial';
    ctx.fillText(el.label, p.x, p.y);
  });
}

/* Handles + hover feedback + cursors */
const HANDLE=7; // screen px
const rectHandles=el=>[
  {k:'nw',x:el.x,y:el.y, cur:'nwse'},
  {k:'n', x:el.x+el.w/2,y:el.y, cur:'ns'},
  {k:'ne',x:el.x+el.w,y:el.y, cur:'nesw'},
  {k:'e', x:el.x+el.w,y:el.y+el.h/2, cur:'ew'},
  {k:'se',x:el.x+el.w,y:el.y+el.h, cur:'nwse'},
  {k:'s', x:el.x+el.w/2,y:el.y+el.h, cur:'ns'},
  {k:'sw',x:el.x,y:el.y+el.h, cur:'nesw'},
  {k:'w', x:el.x,y:el.y+el.h/2, cur:'ew'},
];
function drawHandles(){
  ctx.setTransform(1,0,0,1,0,0);
  elements.forEach(el=>{
    if(!el.resizable) return;
    const isSel = selected && selected.id===el.id;
    const fill = isSel ? '#e0f2fe' : '#fff';
    if(el.type==='rect'){
      rectHandles(el).forEach(h=>{
        const p=screenPoint(h.x,h.y);
        ctx.strokeStyle='#111'; ctx.fillStyle=fill;
        if(hoverHandle && hoverHandle.el===el && hoverHandle.handle===h.k){
          ctx.fillStyle='#c7d2fe'; // glow-ish
          ctx.shadowColor='#6366f1'; ctx.shadowBlur=8;
        }
        ctx.beginPath(); ctx.rect(p.x-HANDLE,p.y-HANDLE,HANDLE*2,HANDLE*2); ctx.fill(); ctx.stroke();
        ctx.shadowBlur=0;
      });
    }else if(el.type==='circle'){
      const p=screenPoint(el.x+el.r, el.y);
      ctx.strokeStyle='#111'; ctx.fillStyle= fill;
      if(hoverHandle && hoverHandle.el===el){ ctx.fillStyle='#c7d2fe'; ctx.shadowColor='#6366f1'; ctx.shadowBlur=8; }
      ctx.beginPath(); ctx.rect(p.x-HANDLE,p.y-HANDLE,HANDLE*2,HANDLE*2); ctx.fill(); ctx.stroke();
      ctx.shadowBlur=0;
    }
  });
}

/* ===== Picking ===== */
function canvasPoint(cx,cy){ const r=canvas.getBoundingClientRect(); return {x:cx-r.left, y:cy-r.top}; }
function toWorld(px,py){ return {x:(px-panX)/viewScale, y:(py-panY)/viewScale}; }
function pickAt(wx,wy){
  for(let i=elements.length-1;i>=0;i--){
    const el=elements[i];
    if(el.type==='rect' && wx>=el.x && wx<=el.x+el.w && wy>=el.y && wy<=el.y+el.h) return el;
    if(el.type!=='rect'){
      const r=(el.r||15) + (el.type==='special'?18:15);
      if(Math.hypot(wx-el.x, wy-el.y)<=r) return el;
    }
  }
  return null;
}
function hitHandle(sx,sy){
  for(let i=elements.length-1;i>=0;i--){
    const el=elements[i]; if(!el.resizable) continue;
    if(el.type==='rect'){
      for(const h of rectHandles(el)){
        const p=screenPoint(h.x,h.y);
        if(Math.abs(sx-p.x)<=HANDLE && Math.abs(sy-p.y)<=HANDLE) return {el,kind:'rect',handle:h.k, cur:h.cur};
      }
    }else{
      const p=screenPoint(el.x+el.r, el.y);
      if(Math.abs(sx-p.x)<=HANDLE && Math.abs(sy-p.y)<=HANDLE) return {el,kind:'circle',handle:'cRadius',cur:'ew'};
    }
  }
  return null;
}

/* ===== Input & interactions ===== */
function setCursorFromHandle(h){
  if(!h){ wrap.classList.remove('cursor-ns','cursor-ew','cursor-nwse','cursor-nesw'); wrap.classList.add('cursor-default'); return; }
  wrap.classList.remove('cursor-default','cursor-ns','cursor-ew','cursor-nwse','cursor-nesw');
  const map={ns:'cursor-ns',ew:'cursor-ew',nwse:'cursor-nwse',nesw:'cursor-nesw'};
  wrap.classList.add(map[h.cur]||'cursor-default');
}
function showTip(text, px, py){
  tooltip.style.display='block'; tooltip.textContent=text;
  tooltip.style.left=px+'px'; tooltip.style.top=py+'px';
}
function hideTip(){ tooltip.style.display='none'; }

canvas.addEventListener('mousemove', (e)=>{
  const p=canvasPoint(e.clientX,e.clientY);
  // hover: handles and cursor
  if(!dragging && !resizing){
    hoverHandle = hitHandle(p.x*DPR(), p.y*DPR());
    setCursorFromHandle(hoverHandle);
    draw(); // redraw handle glow
  }
});
canvas.addEventListener('mousedown',(e)=>{
  const p=canvasPoint(e.clientX,e.clientY), now=Date.now();
  if(addMode){ placeNew(p); return; }
  const h=hitHandle(p.x*DPR(), p.y*DPR());
  if(h){ resizing=h; selected=h.el; snapshot(); draw(); return; }

  const w=toWorld(p.x,p.y); const el=pickAt(w.x,w.y);
  if(el){ dragging=el; selected=el; dragOffX=w.x-el.x; dragOffY=w.y-el.y; snapshot(); draw(); }
  else { selected=null; panning=true; panStartX=p.x-panX; panStartY=p.y-panY; inertiaVX=inertiaVY=0; lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y; }

  if(now-lastTap<280){ zoomAt(p.x,p.y,1.6); } lastTap=now;
});
window.addEventListener('mousemove',(e)=>{
  const p=canvasPoint(e.clientX,e.clientY);
  if(resizing){ doResize(p); return; }
  if(dragging){
    const w=toWorld(p.x,p.y);
    dragging.x=w.x-dragOffX; dragging.y=w.y-dragOffY;
    if(lockCassInput.checked && dragging.id==='conuco'){ rebuildCassava(parseInt(cassCountInput.value,10)||0); }
    updateMeasurements(); draw(); return;
  }
  if(panning){
    const now=Date.now();
    inertiaVX=(p.x-lastMoveX)/Math.max(1,now-lastMoveTime);
    inertiaVY=(p.y-lastMoveY)/Math.max(1,now-lastMoveTime);
    lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y;
    panX=p.x-panStartX; panY=p.y-panStartY; draw();
  }
});
window.addEventListener('mouseup',()=>{ if(panning) startInertia(); dragging=null; panning=false; resizing=null; hoverHandle=null; hideTip(); setCursorFromHandle(null); });

canvas.addEventListener('wheel',(e)=>{ e.preventDefault(); const p=canvasPoint(e.clientX,e.clientY); zoomAt(p.x,p.y, e.deltaY<0?1.1:1/1.1); }, {passive:false});

/* Touch */
canvas.addEventListener('touchstart',(e)=>{
  if(addMode){ const t=e.touches[0]; placeNew(canvasPoint(t.clientX,t.clientY)); e.preventDefault(); return; }
  if(e.touches.length===1){
    const t=e.touches[0], p=canvasPoint(t.clientX,t.clientY), now=Date.now();
    const h=hitHandle(p.x*DPR(), p.y*DPR());
    if(h){ resizing=h; selected=h.el; snapshot(); draw(); e.preventDefault(); return; }
    const w=toWorld(p.x,p.y), el=pickAt(w.x,w.y);
    if(el){ dragging=el; selected=el; dragOffX=w.x-el.x; dragOffY=w.y-el.y; snapshot(); draw(); }
    else { selected=null; panning=true; panStartX=p.x-panX; panStartY=p.y-panY; inertiaVX=inertiaVY=0; lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y; }
    if(now-lastTap<320){ zoomAt(p.x,p.y,1.6); e.preventDefault(); } lastTap=now;
  }else if(e.touches.length===2){
    pinching=true; dragging=null; panning=false;
    const a=e.touches[0], b=e.touches[1];
    pinchStartDist=Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY);
    pinchStartScale=viewScale;
    const cx=(a.clientX+b.clientX)/2, cy=(a.clientY+b.clientY)/2, q=canvasPoint(cx,cy);
    pinchFocalX=q.x; pinchFocalY=q.y;
  }
},{passive:false});
canvas.addEventListener('touchmove',(e)=>{
  if(resizing){ const t=e.touches[0], p=canvasPoint(t.clientX,t.clientY); doResize(p); e.preventDefault(); return; }
  if(pinching && e.touches.length===2){
    e.preventDefault();
    const a=e.touches[0], b=e.touches[1];
    const factor=Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY)/pinchStartDist;
    setZoomAt(pinchFocalX,pinchFocalY,pinchStartScale*factor);
  }else if(e.touches.length===1 && (dragging||panning)){
    e.preventDefault();
    const t=e.touches[0], p=canvasPoint(t.clientX,t.clientY);
    if(dragging){
      const w=toWorld(p.x,p.y);
      dragging.x=w.x-dragOffX; dragging.y=w.y-dragOffY;
      if(lockCassInput.checked && dragging.id==='conuco'){ rebuildCassava(parseInt(cassCountInput.value,10)||0); }
      updateMeasurements(); draw();
    }else{
      const now=Date.now();
      inertiaVX=(p.x-lastMoveX)/Math.max(1,now-lastMoveTime);
      inertiaVY=(p.y-lastMoveY)/Math.max(1,now-lastMoveTime);
      lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y;
      panX=p.x-panStartX; panY=p.y-panStartY; draw();
    }
  }
},{passive:false});
canvas.addEventListener('touchend',()=>{ if(panning && !pinching) startInertia(); pinching=false; dragging=null; panning=false; resizing=null; hoverHandle=null; hideTip(); });

/* Resize logic + tooltip */
function doResize(p){
  const w=toWorld(p.x,p.y), el=resizing.el;
  if(resizing.kind==='rect'){
    const min=20; let L=el.x, R=el.x+el.w, T=el.y, B=el.y+el.h;
    const setL=nx=>{L=Math.min(nx,R-min); el.w=R-L; el.x=L;}
    const setR=nx=>{R=Math.max(nx,L+min); el.w=R-L;}
    const setT=ny=>{T=Math.min(ny,B-min); el.h=B-T; el.y=T;}
    const setB=ny=>{B=Math.max(ny,T+min); el.h=B-T;}
    const h=resizing.handle;
    if(h.includes('w')) setL(w.x); if(h.includes('e')) setR(w.x);
    if(h.includes('n')) setT(w.y); if(h.includes('s')) setB(w.y);
    const mid=screenPoint(el.x+el.w/2, el.y);
    showTip(`${(el.w/SCALE).toFixed(1)} ft × ${(el.h/SCALE).toFixed(1)} ft`, mid.x, mid.y);
  }else{ // circle
    el.r=Math.max(6,Math.abs(w.x-el.x));
    if(lockCassInput.checked && el.id==='conuco'){ rebuildCassava(parseInt(cassCountInput.value,10)||0); }
    const rim=screenPoint(el.x+el.r, el.y);
    showTip(`R ${(el.r/SCALE).toFixed(1)} ft · D ${(el.r*2/SCALE).toFixed(1)} ft`, rim.x, rim.y);
  }
  updateMeasurements(); draw();
}

/* Zoom + inertia */
function clamp(v,lo,hi){ return Math.max(lo,Math.min(hi,v)); }
function setZoomAt(fx,fy,newScale){
  newScale=clamp(newScale,MIN_SCALE,MAX_SCALE);
  const wx=(fx-panX)/viewScale, wy=(fy-panY)/viewScale;
  viewScale=newScale; panX=fx-wx*viewScale; panY=fy-wy*viewScale; draw();
}
function zoomAt(fx,fy,k){ setZoomAt(fx,fy,viewScale*k); }
function startInertia(){
  if(inertiaId) cancelAnimationFrame(inertiaId);
  const decay=.92, min=.02; let last=performance.now();
  const step=t=>{
    const dt=Math.max(.016,(t-last)/16.67); last=t;
    panX+=inertiaVX*16.67*dt; panY+=inertiaVY*16.67*dt;
    inertiaVX*=Math.pow(decay,dt); inertiaVY*=Math.pow(decay,dt);
    draw();
    if(Math.abs(inertiaVX)+Math.abs(inertiaVY)>min) inertiaId=requestAnimationFrame(step); else inertiaId=0;
  };
  if(Math.abs(inertiaVX)+Math.abs(inertiaVY)>min) inertiaId=requestAnimationFrame(step);
}

/* Mini-map + Fit */
function worldBounds(){
  let minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;
  elements.forEach(e=>{
    if(e.type==='rect'){ minX=Math.min(minX,e.x); minY=Math.min(minY,e.y); maxX=Math.max(maxX,e.x+e.w); maxY=Math.max(maxY,e.y+e.h); }
    else{ const r=e.r||15; minX=Math.min(minX,e.x-r); minY=Math.min(minY,e.y-r); maxX=Math.max(maxX,e.x+r); maxY=Math.max(maxY,e.y+r); }
  });
  return {minX,minY,maxX,maxY};
}
function drawMiniMap(){
  mctx.setTransform(1,0,0,1,0,0); mctx.clearRect(0,0,mini.width,mini.height);
  const b=worldBounds(), WW=b.maxX-b.minX, WH=b.maxY-b.minY, ratio=DPR();
  const pad=6*ratio, vw=mini.width-pad*2, vh=mini.height-pad*2, s=Math.min(vw/WW, vh/WH);
  const ox=pad - b.minX*s, oy=pad - b.minY*s;
  mctx.strokeStyle='#333'; mctx.lineWidth=1*ratio;
  mctx.strokeRect(b.minX*s+ox, b.minY*s+oy, WW*s, WH*s);
  elements.forEach(e=>{
    mctx.strokeStyle='#666';
    if(e.type==='rect') mctx.strokeRect(e.x*s+ox,e.y*s+oy,e.w*s,e.h*s);
    else { const r=(e.r||15)*s; mctx.beginPath(); mctx.arc(e.x*s+ox,e.y*s+oy,r,0,Math.PI*2); mctx.stroke(); }
  });
  const r=canvas.getBoundingClientRect(), cssW=r.width, cssH=r.height;
  const tlx=(-panX)/viewScale, tly=(-panY)/viewScale, brx=(cssW-panX)/viewScale, bry=(cssH-panY)/viewScale;
  mctx.strokeStyle= '#0a84ff'; mctx.lineWidth=2*ratio;
  mctx.strokeRect(tlx*s+ox, tly*s+oy, (brx-tlx)*s, (bry-tly)*s);
}
function fitToExtents(){
  const b=worldBounds(), rect=canvas.getBoundingClientRect(), pad=40;
  const s=Math.min((rect.width-pad*2)/(b.maxX-b.minX), (rect.height-pad*2)/(b.maxY-b.minY));
  viewScale=clamp(s,MIN_SCALE,MAX_SCALE);
  const cx=(b.minX+b.maxX)/2, cy=(b.minY+b.maxY)/2;
  panX=rect.width/2 - cx*viewScale; panY=rect.height/2 - cy*viewScale; draw();
}

/* Add / place / delete */
function placeNew(p){
  const w=toWorld(p.x,p.y);
  if(addMode==='rect'){
    const label = prompt('Label for rectangle:', 'STRUCTURE'); addMode=null; if(label===null) return;
    elements.push({id:'rect'+rand(),type:'rect',x:w.x-50,y:w.y-35,w:100,h:70,color:'#d9d9d9',label:label||'STRUCTURE',draggable:true,resizable:true});
  }else if(addMode==='circle'){
    const label = prompt('Label for circle:', 'FEATURE'); addMode=null; if(label===null) return;
    elements.push({id:'circle'+rand(),type:'circle',x:w.x,y:w.y,r:30,color:'#ddd',label:label||'FEATURE',draggable:true,resizable:true});
  }
  snapshot(); selected=null; updateMeasurements(); draw(); refreshList();
}

/* Sidebar list */
const list=document.getElementById('shapeList');
const renameBtn=document.getElementById('renameBtn');
const sideDeleteBtn=document.getElementById('sideDeleteBtn');
function iconFor(e){ return e.type==='rect'?'#d1d5db': e.type==='circle'?'#e5e7eb':'#fde68a'; }
function refreshList(){
  list.innerHTML='';
  elements.forEach(e=>{
    const li=document.createElement('li'); li.className='shape-item'+(selected && selected.id===e.id?' active':'');
    const chip=document.createElement('span'); chip.className='shape-chip'; chip.style.background= e.color || iconFor(e);
    const name=document.createElement('div'); name.className='shape-name'; name.textContent=e.label || e.id;
    li.appendChild(chip); li.appendChild(name); list.appendChild(li);
    li.onclick=()=>{ selected=e; draw(); refreshList(); };
  });
}
renameBtn.onclick=()=>{ if(!selected) return; const txt=prompt('New label:', selected.label||selected.id); if(txt===null) return; selected.label=txt||selected.label; snapshot(); draw(); refreshList(); };
sideDeleteBtn.onclick=delSelected;

/* Buttons */
applyBtn.onclick=()=>{ rebuildCassava(parseInt(cassCountInput.value,10)||0); snapshot(); draw(); refreshList(); };
resetBtn.onclick=()=>{ panX=panY=0; viewScale=1; buildDefaults(); snapshot(); draw(); refreshList(); };
centerBtn.onclick=()=>{ panX=panY=0; viewScale=1; draw(); };
gridBtn.onclick=()=>{ showGrid=!showGrid; draw(); };
fitBtn.onclick=fitToExtents;
undoBtn.onclick=doUndo; redoBtn.onclick=doRedo;
addRectBtn.onclick=()=>{ addMode='rect'; };
addCircleBtn.onclick=()=>{ addMode='circle'; };
delSelectedBtn.onclick=delSelected;
clearCassBtn.onclick=()=>{ removeCassava(); snapshot(); draw(); refreshList(); };
function delSelected(){ if(!selected) return; elements=elements.filter(e=>e!==selected); selected=null; snapshot(); draw(); refreshList(); }

/* Keyboard shortcuts */
window.addEventListener('keydown',(e)=>{
  if(e.key==='Delete' || e.key==='Backspace'){ if(selected){ e.preventDefault(); delSelected(); } }
  if(e.key==='g' || e.key==='G'){ showGrid=!showGrid; draw(); }
  if(e.key==='f' || e.key==='F'){ fitToExtents(); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); doUndo(); }
  if((e.ctrlKey||e.metaKey) && (e.key.toLowerCase()==='y' || (e.shiftKey && e.key.toLowerCase()==='z'))){ e.preventDefault(); doRedo(); }
});

/* Canvas size / observer */
function resizeCanvas(){
  const r=wrap.getBoundingClientRect(), ratio=DPR();
  canvas.width=Math.max(1,Math.floor(r.width*ratio));
  canvas.height=Math.max(1,Math.floor(r.height*ratio));
  const mr=mini.getBoundingClientRect();
  mini.width=Math.max(1,Math.floor(mr.width*ratio));
  mini.height=Math.max(1,Math.floor(mr.height*ratio));
  CENTER_X=r.width/2; CENTER_Y=r.height/2;
  draw();
}
new ResizeObserver(resizeCanvas).observe(wrap);

/* Build defaults & init */
function buildDefaults(){
  elements=[
    rectEl('barn',defaults.barn),
    rectEl('house',defaults.house),
    rectEl('planter',defaults.planter),
    circleEl('septic',defaults.septic),
    circleEl('conuco',defaults.conuco),
    rectEl('yopo',defaults.yopo),
    palmEl('palm',defaults.palm)
  ];
  rebuildCassava(parseInt(cassCountInput.value,10)||8);
  updateMeasurements();
}
buildDefaults();
resizeCanvas();
draw();
refreshList();
updateHistoryButtons();
</script>
</body>
</html>
