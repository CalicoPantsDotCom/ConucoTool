<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes, viewport-fit=cover" />
<title>Taíno Conuco Layout • v6.1</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{--gap:10px;--radius:10px}
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f5f1e8;color:#222;line-height:1.3;padding:var(--gap)}
  .container{width:min(100%,920px);margin-inline:auto;background:#fff;border:2px solid #333;padding:var(--gap);border-radius:var(--radius)}
  h1{font-size:clamp(14px,3.8vw,20px);text-align:center;margin-bottom:4px}
  .badge{font-size:11px;color:#666;text-align:center;margin-bottom:8px}
  .hint{font-size:12px;color:#444;margin-bottom:8px;text-align:left}
  .controls{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:8px}
  @media (max-width:640px){.controls{grid-template-columns:repeat(3,1fr)}}
  button{padding:12px;background:#4a4a4a;color:#fff;border:0;border-radius:8px;font-size:clamp(11px,3.2vw,14px);cursor:pointer;touch-action:manipulation}
  button:active{background:#666}
  .measurements{background:#fffde7;padding:8px;margin-bottom:10px;font-size:12px;border-left:3px solid #daa520;border-radius:6px;min-height:20px}
  .live{color:#06c;font-weight:700}
  #canvasWrapper{width:100%;height:min(62dvh,560px);min-height:260px;border:2px solid #333;background:#fff;overflow:hidden;position:relative;border-radius:var(--radius)}
  canvas{display:block;width:100%;height:100%;touch-action:none}
  #miniMap{position:absolute;right:8px;bottom:8px;width:140px;height:100px;border:1px solid #333;background:#ffffffcc;border-radius:6px;touch-action:none}
</style>
</head>
<body>
  <div class="container">
    <h1>Taíno Conuco Layout Tool</h1>
    <div class="badge">build v6.1 • research defaults (9 ft mound, 2 cassava) • crisp text • resizable shapes • pinch+zoom • inertia • fit • minimap</div>
    <div class="controls">
      <button id="applyBtn">Apply</button>
      <button id="resetBtn">Reset</button>
      <button id="centerBtn">Center</button>
      <button id="gridBtn">Grid</button>
      <button id="fitBtn">Fit</button>
    </div>
    <div class="hint">Drag shapes to move. Drag handles to resize (rect: 8 handles, circle: radius handle). Double-tap to zoom.</div>
    <div class="measurements" id="measurements">Loading…</div>
    <div id="canvasWrapper">
      <canvas id="canvas"></canvas>
      <canvas id="miniMap"></canvas>
    </div>
  </div>

<script>
/* ---------- Basics ---------- */
if(!Math.hypot){Math.hypot=function(x,y){return Math.sqrt(x*x+y*y)}}
var canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d',{alpha:true});
var wrapper=document.getElementById('canvasWrapper');
var mini=document.getElementById('miniMap'), mctx=mini.getContext('2d');

var SCALE=10; // px per foot for measurements
var CENTER_X=350, CENTER_Y=400, showGrid=true;

var panX=0, panY=0, viewScale=1, MIN_SCALE=0.5, MAX_SCALE=4;
var dragging=null, dragOffX=0, dragOffY=0;
var resizing=null; // {el, kind:'rect'|'circle', handle:'n'|'s'|'e'|'w'|'ne'...'cRadius'}
var panning=false, panStartX=0, panStartY=0;
var pinching=false, pinchStartDist=0, pinchStartScale=1, pinchFocalX=0, pinchFocalY=0;
var inertiaVX=0, inertiaVY=0, inertiaId=0, lastMoveTime=0, lastMoveX=0, lastMoveY=0, lastTap=0;

var elements=[];

/* ---------- Research defaults ---------- */
/* 9 ft diameter conuco -> radius = 4.5 ft -> 45 px */
var defaults = {
  barn:    { x:-260, y:  40, w:180, h:140, label:'BARN'  },
  house:   { x: 130, y:  40, w:160, h:160, label:'HOUSE' },
  planter: { x:-160, y:-210, w: 90, h: 60, label:'PLANTER' },
  septic:  { x:-150, y: 270, r: 40, label:'SEPTIC' }, // 4 ft-ish radius
  conuco:  { x:  20, y:-160, r: 45, label:'CONUCO' },
  yopo:    { x:  -5, y:-105, w: 30, h: 30, label:'Y'     },
  palm:    { x: 130, y: 240, r: 18, label:'PALM', special:true }
};

/* ---------- UI wiring ---------- */
document.getElementById('applyBtn').onclick = function(){ createElements(); draw(); };
document.getElementById('resetBtn').onclick = resetToResearch;
document.getElementById('centerBtn').onclick = function(){ panX=panY=0; viewScale=1; draw(); };
document.getElementById('gridBtn').onclick = function(){ showGrid=!showGrid; draw(); };
document.getElementById('fitBtn').onclick = fitToExtents;

/* ---------- Element creation ---------- */
function createElements(){
  elements = [
    rectEl('barn',  defaults.barn),
    rectEl('house', defaults.house),
    rectEl('planter', defaults.planter),
    circleEl('septic', defaults.septic, true),
    circleEl('conuco', defaults.conuco, false),
    rectEl('yopo', defaults.yopo),
    specialPalm('palm', defaults.palm)
  ];

  // Place TWO cassava nodes on conuco rim @ 0° and 180°
  var c = elements.filter(function(e){return e.id==='conuco'})[0];
  var ring = c.r - 6;
  var offs = [[ ring,0],[-ring,0]];
  for (var i=0;i<offs.length;i++){
    elements.push({ id:'cassava'+(i+1), type:'circle', x:c.x+offs[i][0]+CENTER_X, y:c.y+offs[i][1]+CENTER_Y,
      r:6, color:'#228b22', label:'', draggable:true, resizable:false });
  }

  updateMeasurements();
}

function worldX(dx){return CENTER_X+dx}
function worldY(dy){return CENTER_Y+dy}

function rectEl(id, o){
  return { id:id, type:'rect', x:worldX(o.x), y:worldY(o.y), w:o.w, h:o.h,
    color:(id==='house'?'#e8dcc8':id==='barn'?'#d4c5a0':id==='planter'?'#c07860':'#4a4a4a'),
    label:o.label, draggable:true, resizable:true };
}
function circleEl(id, o, dashed){
  return { id:id, type:'circle', x:worldX(o.x), y:worldY(o.y), r:o.r,
    color:(id==='conuco'?'#8b7355':'#e0e0e0'), label:o.label, draggable:true, resizable:true, dash:!!dashed };
}
function specialPalm(id, o){
  return { id:id, type:'special', x:worldX(o.x), y:worldY(o.y), r:o.r, color:'#8b7355',
    label:o.label, draggable:true, resizable:false };
}

/* ---------- Measurements ---------- */
function updateMeasurements(){
  var m=document.getElementById('measurements');
  function get(id){for(var i=0;i<elements.length;i++) if(elements[i].id===id) return elements[i]}
  function dist(a,b){return Math.hypot(a.x-b.x, a.y-b.y)/SCALE}
  var barn=get('barn'), house=get('house'), planter=get('planter'),
      conuco=get('conuco'), septic=get('septic'), palm=get('palm');

  m.innerHTML =
    '<div>Barn → Planter: <span class="live">'+dist(barn,planter).toFixed(1)+'</span> ft</div>'+
    '<div>Barn → Septic: <span class="live">'+dist(barn,septic).toFixed(1)+'</span> ft</div>'+
    '<div>Barn → House (gap): <span class="live">'+(Math.abs(house.x-(barn.x+barn.w))/SCALE).toFixed(1)+'</span> ft</div>'+
    '<div>House → Palm: <span class="live">'+dist(house,palm).toFixed(1)+'</span> ft</div>'+
    '<div>Conuco radius: <span class="live">'+(conuco.r/SCALE).toFixed(1)+'</span> ft</div>';
}

/* ---------- Drawing ---------- */
function draw(){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  // Clear
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Apply world transform
  ctx.setTransform(dpr*viewScale,0,0,dpr*viewScale,dpr*panX,dpr*panY);

  var w=canvas.width/dpr, h=canvas.height/dpr;

  if (showGrid){
    ctx.strokeStyle='#ddd'; ctx.lineWidth=1/viewScale;
    for (var x=0;x<=w;x+=100){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke()}
    for (var y=0;y<=h;y+=100){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke()}
    ctx.strokeStyle='#999'; ctx.lineWidth=2/viewScale;
    ctx.beginPath();ctx.moveTo(CENTER_X,0);ctx.lineTo(CENTER_X,h);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,CENTER_Y);ctx.lineTo(w,CENTER_Y);ctx.stroke();
  }

  // Shapes
  for(var i=0;i<elements.length;i++) drawElement(elements[i]);

  // Crisp labels in screen space
  drawLabelsCrisp();

  // Resize handles on selected/resizable shapes
  drawHandles();

  drawMiniMap();
}

function drawElement(el){
  if(el.type==='rect'){
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=2/viewScale;
    ctx.fillRect(el.x,el.y,el.w,el.h); ctx.strokeRect(el.x,el.y,el.w,el.h);
  } else if(el.type==='circle'){
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=(el.r>10?2:1)/viewScale;
    if(el.dash) ctx.setLineDash([5/viewScale,5/viewScale]);
    ctx.beginPath(); ctx.arc(el.x,el.y,el.r,0,Math.PI*2); ctx.fill(); ctx.stroke(); ctx.setLineDash([]);
  } else { // special palm (trunk + fronds)
    ctx.fillStyle=el.color; ctx.strokeStyle='#333'; ctx.lineWidth=2/viewScale;
    ctx.beginPath(); ctx.ellipse(el.x,el.y,12,20,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.strokeStyle='#2d5016';
    for (var i=0;i<5;i++){ ctx.beginPath(); ctx.moveTo(el.x,el.y-15);
      var a=(i-2)*0.4; ctx.quadraticCurveTo(el.x+Math.sin(a)*15, el.y-30, el.x+Math.sin(a)*20, el.y-40); ctx.stroke(); }
  }
}

/* ---------- Crisp text (screen-space) ---------- */
function worldToScreen(wx,wy){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  return { x:(wx*viewScale+panX)*dpr, y:(wy*viewScale+panY)*dpr };
}
function drawLabelsCrisp(){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  ctx.setTransform(1,0,0,1,0,0); // screen space
  ctx.textAlign='center';
  for (var i=0;i<elements.length;i++){
    var el=elements[i]; if(!el.label) continue;
    var centerX = (el.type==='rect') ? el.x + el.w/2 : el.x;
    var centerY = (el.type==='rect') ? el.y + el.h/2 : el.y;
    var p = worldToScreen(centerX, centerY + 3/viewScale);
    var size = (el.type==='rect' ? 12 : (el.r>30?10:9));
    ctx.fillStyle='#000';
    ctx.font = 'bold ' + Math.round(size*dpr) + 'px Arial';
    ctx.fillText(el.label, p.x, p.y);
  }
}

/* ---------- Resize handles ---------- */
var HANDLE_SIZE = 7; // screen px
function getRectHandles(el){
  var pts = [
    {key:'nw', x:el.x,        y:el.y       },
    {key:'n',  x:el.x+el.w/2, y:el.y       },
    {key:'ne', x:el.x+el.w,   y:el.y       },
    {key:'e',  x:el.x+el.w,   y:el.y+el.h/2},
    {key:'se', x:el.x+el.w,   y:el.y+el.h  },
    {key:'s',  x:el.x+el.w/2, y:el.y+el.h  },
    {key:'sw', x:el.x,        y:el.y+el.h  },
    {key:'w',  x:el.x,        y:el.y+el.h/2}
  ];
  return pts;
}
function drawHandles(){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  ctx.setTransform(1,0,0,1,0,0); // screen space
  ctx.lineWidth=1;
  for (var i=0;i<elements.length;i++){
    var el=elements[i]; if(!el.resizable) continue;

    if(el.type==='rect'){
      var hs = getRectHandles(el);
      for (var j=0;j<hs.length;j++){
        var p = worldToScreen(hs[j].x, hs[j].y);
        ctx.strokeStyle='#111'; ctx.fillStyle='#fff';
        ctx.beginPath(); ctx.rect(p.x-HANDLE_SIZE, p.y-HANDLE_SIZE, HANDLE_SIZE*2, HANDLE_SIZE*2);
        ctx.fill(); ctx.stroke();
      }
    } else if(el.type==='circle'){
      var rim = worldToScreen(el.x+el.r, el.y);
      ctx.strokeStyle='#111'; ctx.fillStyle='#fff';
      ctx.beginPath(); ctx.rect(rim.x-HANDLE_SIZE, rim.y-HANDLE_SIZE, HANDLE_SIZE*2, HANDLE_SIZE*2);
      ctx.fill(); ctx.stroke();
    }
  }
}

/* Hit-testing handles (screen space rectangles) */
function hitTestHandle(screenX,screenY){
  for (var i=elements.length-1;i>=0;i--){
    var el=elements[i]; if(!el.resizable) continue;

    if(el.type==='rect'){
      var hs=getRectHandles(el);
      for (var j=0;j<hs.length;j++){
        var p=worldToScreen(hs[j].x, hs[j].y);
        if (Math.abs(screenX-p.x)<=HANDLE_SIZE && Math.abs(screenY-p.y)<=HANDLE_SIZE){
          return {el:el, kind:'rect', handle:hs[j].key};
        }
      }
    } else if(el.type==='circle'){
      var rim=worldToScreen(el.x+el.r, el.y);
      if (Math.abs(screenX-rim.x)<=HANDLE_SIZE && Math.abs(screenY-rim.y)<=HANDLE_SIZE){
        return {el:el, kind:'circle', handle:'cRadius'};
      }
    }
  }
  return null;
}

/* ---------- Picking & input ---------- */
function screenToWorld(px,py){ return {x:(px-panX)/viewScale, y:(py-panY)/viewScale}; }
function getElementAtWorld(x,y){
  for (var i=elements.length-1;i>=0;i--){
    var el=elements[i];
    if(!el.draggable) continue;
    if(el.type==='rect' && x>=el.x && x<=el.x+el.w && y>=el.y && y<=el.y+el.h) return el;
    if(el.type==='circle' || el.type==='special'){
      var r=(el.r||15); if(Math.hypot(x-el.x,y-el.y)<=r+(el.type==='special'?18:15)) return el;
    }
  }
  return null;
}
function getCanvasCoordsClient(cx,cy){ var r=canvas.getBoundingClientRect(); return {x:(cx-r.left), y:(cy-r.top)}; }

/* Mouse */
canvas.addEventListener('mousedown', function(e){
  var p=getCanvasCoordsClient(e.clientX,e.clientY);
  // check handles first
  var h = hitTestHandle(p.x*devicePixelRatio, p.y*devicePixelRatio);
  if (h){ resizing=h; return; }

  var w=screenToWorld(p.x,p.y);
  var el=getElementAtWorld(w.x,w.y);
  if(el){ dragging=el; dragOffX=w.x-el.x; dragOffY=w.y-el.y; }
  else { panning=true; panStartX=p.x-panX; panStartY=p.y-panY; inertiaVX=inertiaVY=0; lastMoveTime=Date.now(); lastMoveX=p.x; lastMoveY=p.y; }

  var now=Date.now(); if(now-lastTap<280){ zoomAt(p.x,p.y,1.6);} lastTap=now;
});
window.addEventListener('mousemove', function(e){
  var p=getCanvasCoordsClient(e.clientX,e.clientY);
  if(resizing){ handleResize(p); return; }
  if(dragging){
    var w=screenToWorld(p.x,p.y);
    dragging.x=w.x - dragOffX; dragging.y=w.y - dragOffY;
    updateMeasurements(); draw(); return;
  }
  if(panning){
    var now=Date.now();
    inertiaVX=(p.x-lastMoveX)/Math.max(1,now-lastMoveTime);
    inertiaVY=(p.y-lastMoveY)/Math.max(1,now-lastMoveTime);
    lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y;
    panX=p.x-panStartX; panY=p.y-panStartY; draw();
  }
});
window.addEventListener('mouseup', function(){
  if(panning) startInertia();
  dragging=null; panning=false; resizing=null;
});

/* Touch */
canvas.addEventListener('touchstart', function(e){
  var t=e.touches[0], p=getCanvasCoordsClient(t.clientX,t.clientY);
  var h=hitTestHandle(p.x*devicePixelRatio, p.y*devicePixelRatio);
  if (h){ resizing=h; e.preventDefault(); return; }

  if(e.touches.length===1){
    var w=screenToWorld(p.x,p.y), el=getElementAtWorld(w.x,w.y);
    if(el){ dragging=el; dragOffX=w.x-el.x; dragOffY=w.y-el.y; }
    else { panning=true; panStartX=p.x-panX; panStartY=p.y-panY; inertiaVX=inertiaVY=0; lastMoveTime=Date.now(); lastMoveX=p.x; lastMoveY=p.y; }
    var now=Date.now(); if(now-lastTap<320){ zoomAt(p.x,p.y,1.6); e.preventDefault(); } lastTap=now;
  } else if(e.touches.length===2){
    pinching=true; dragging=null; panning=false;
    var a=e.touches[0], b=e.touches[1];
    pinchStartDist=Math.hypot(b.clientX-a.clientX, b.clientY-a.clientY);
    pinchStartScale=viewScale;
    var cx=(a.clientX+b.clientX)/2, cy=(a.clientY+b.clientY)/2, q=getCanvasCoordsClient(cx,cy);
    pinchFocalX=q.x; pinchFocalY=q.y;
  }
},{passive:false});

canvas.addEventListener('touchmove', function(e){
  if(resizing){ var t=e.touches[0], p=getCanvasCoordsClient(t.clientX,t.clientY); handleResize(p); e.preventDefault(); return; }
  if(pinching && e.touches.length===2){
    e.preventDefault();
    var a=e.touches[0], b=e.touches[1];
    var dist=Math.hypot(b.clientX-a.clientX, b.clientY-a.clientY);
    var factor=dist/pinchStartDist;
    setZoomAt(pinchFocalX,pinchFocalY, pinchStartScale*factor);
  } else if(e.touches.length===1 && (dragging||panning)){
    e.preventDefault();
    var t=e.touches[0], p=getCanvasCoordsClient(t.clientX,t.clientY);
    if(dragging){
      var w=screenToWorld(p.x,p.y);
      dragging.x=w.x - dragOffX; dragging.y=w.y - dragOffY;
      updateMeasurements(); draw();
    } else {
      var now=Date.now();
      inertiaVX=(p.x-lastMoveX)/Math.max(1,now-lastMoveTime);
      inertiaVY=(p.y-lastMoveY)/Math.max(1,now-lastMoveTime);
      lastMoveTime=now; lastMoveX=p.x; lastMoveY=p.y;
      panX=p.x-panStartX; panY=p.y-panStartY; draw();
    }
  }
},{passive:false});

canvas.addEventListener('touchend', function(){
  if(panning && !pinching) startInertia();
  pinching=false; dragging=null; panning=false; resizing=null;
});

/* Wheel zoom */
canvas.addEventListener('wheel', function(e){
  e.preventDefault();
  var p=getCanvasCoordsClient(e.clientX,e.clientY);
  zoomAt(p.x,p.y, e.deltaY<0 ? 1.1 : 1/1.1);
},{passive:false});

/* ---------- Resize logic ---------- */
function handleResize(p){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  var w = screenToWorld(p.x,p.y);
  var el = resizing.el;

  if(resizing.kind==='rect'){
    var min=20;
    var left=el.x, right=el.x+el.w, top=el.y, bottom=el.y+el.h;

    function setLeft(nx){ left = Math.min(nx, right-min); el.w = right-left; el.x=left; }
    function setRight(nx){ right= Math.max(nx, left+min); el.w = right-left; }
    function setTop(ny){ top = Math.min(ny, bottom-min); el.h = bottom-top; el.y=top; }
    function setBottom(ny){ bottom= Math.max(ny, top+min); el.h = bottom-top; }

    var h=resizing.handle;
    if(h.indexOf('w')!==-1) setLeft(w.x);
    if(h.indexOf('e')!==-1) setRight(w.x);
    if(h.indexOf('n')!==-1) setTop(w.y);
    if(h.indexOf('s')!==-1) setBottom(w.y);
  } else { // circle radius
    el.r = Math.max(6, Math.abs(w.x - el.x)); // handle along east-west
  }
  updateMeasurements(); draw();
}

/* ---------- Zoom helpers ---------- */
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function setZoomAt(fx,fy,newScale){
  newScale=clamp(newScale,MIN_SCALE,MAX_SCALE);
  var worldX=(fx - panX)/viewScale, worldY=(fy - panY)/viewScale;
  viewScale=newScale;
  panX = fx - worldX*viewScale;
  panY = fy - worldY*viewScale;
  draw();
}
function zoomAt(fx,fy,factor){ setZoomAt(fx,fy,viewScale*factor); }

/* ---------- Inertia ---------- */
function startInertia(){
  if(inertiaId) cancelAnimationFrame(inertiaId);
  var decay=0.92, minSpeed=0.02, last=performance.now();
  function step(t){
    var dt=Math.max(0.016,(t-last)/16.67); last=t;
    panX += inertiaVX*16.67*dt; panY += inertiaVY*16.67*dt;
    inertiaVX *= Math.pow(decay,dt); inertiaVY *= Math.pow(decay,dt);
    draw();
    if(Math.abs(inertiaVX)+Math.abs(inertiaVY)>minSpeed) inertiaId=requestAnimationFrame(step);
    else inertiaId=0;
  }
  if(Math.abs(inertiaVX)+Math.abs(inertiaVY)>minSpeed) inertiaId=requestAnimationFrame(step);
}

/* ---------- Mini-map & Fit ---------- */
function getWorldBounds(){
  var minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;
  for (var i=0;i<elements.length;i++){
    var e=elements[i];
    if(e.type==='rect'){ minX=Math.min(minX,e.x); minY=Math.min(minY,e.y); maxX=Math.max(maxX,e.x+e.w); maxY=Math.max(maxY,e.y+e.h); }
    else { var r=e.r||15; minX=Math.min(minX,e.x-r); minY=Math.min(minY,e.y-r); maxX=Math.max(maxX,e.x+r); maxY=Math.max(maxY,e.y+r); }
  }
  return {minX:minX,minY:minY,maxX:maxX,maxY:maxY};
}
function drawMiniMap(){
  var dpr=Math.max(1,window.devicePixelRatio||1);
  mctx.setTransform(1,0,0,1,0,0); mctx.clearRect(0,0,mini.width,mini.height);
  var b=getWorldBounds(), WW=b.maxX-b.minX, WH=b.maxY-b.minY;
  var pad=6*dpr, vw=mini.width-pad*2, vh=mini.height-pad*2, s=Math.min(vw/WW, vh/WH);
  var ox=pad - b.minX*s, oy=pad - b.minY*s;
  mctx.strokeStyle='#333'; mctx.lineWidth=1*dpr;
  mctx.strokeRect(b.minX*s+ox, b.minY*s+oy, WW*s, WH*s);
  for (var i=0;i<elements.length;i++){
    var e=elements[i]; mctx.strokeStyle='#666';
    if(e.type==='rect'){ mctx.strokeRect(e.x*s+ox, e.y*s+oy, e.w*s, e.h*s); }
    else { var r=(e.r||15)*s; mctx.beginPath(); mctx.arc(e.x*s+ox, e.y*s+oy, r, 0, Math.PI*2); mctx.stroke(); }
  }
  var rect=canvas.getBoundingClientRect(), cssW=rect.width, cssH=rect.height;
  var tlx=(-panX)/viewScale, tly=(-panY)/viewScale, brx=(cssW-panX)/viewScale, bry=(cssH-panY)/viewScale;
  mctx.strokeStyle='#0a84ff'; mctx.lineWidth=2*dpr;
  mctx.strokeRect(tlx*s+ox, tly*s+oy, (brx-tlx)*s, (bry-tly)*s);
}
function fitToExtents(){
  var b=getWorldBounds(), rect=canvas.getBoundingClientRect(), pad=40;
  var viewW=rect.width-pad*2, viewH=rect.height-pad*2;
  var s=Math.min(viewW/(b.maxX-b.minX), viewH/(b.maxY-b.minY));
  s=clamp(s, MIN_SCALE, MAX_SCALE);
  var cx=(b.minX+b.maxX)/2, cy=(b.minY+b.maxY)/2;
  viewScale=s; panX=rect.width/2 - cx*viewScale; panY=rect.height/2 - cy*viewScale; draw();
}

/* ---------- Reset & resizing ---------- */
function resetToResearch(){
  panX=panY=0; viewScale=1;
  createElements(); draw();
}

/* ---------- Resize observer ---------- */
function resizeCanvas(){
  var rect=wrapper.getBoundingClientRect(), dpr=Math.max(1,window.devicePixelRatio||1);
  canvas.width=Math.max(1,Math.floor(rect.width*dpr));
  canvas.height=Math.max(1,Math.floor(rect.height*dpr));
  var mr=mini.getBoundingClientRect();
  mini.width=Math.max(1,Math.floor(mr.width*dpr));
  mini.height=Math.max(1,Math.floor(mr.height*dpr));
  CENTER_X=rect.width/2; CENTER_Y=rect.height/2;
  draw();
}
if(window.ResizeObserver){ new ResizeObserver(resizeCanvas).observe(wrapper); }
else { window.addEventListener('resize',resizeCanvas); window.addEventListener('orientationchange',resizeCanvas); }

/* ---------- Init ---------- */
createElements();
resizeCanvas();
draw();
</script>
</body>
</html>
